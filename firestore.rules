/**
 * @file Firestore Security Rules for Poli Fit Tracker
 * @core_philosophy This ruleset enforces a strict user-ownership model, with a specific exception for administrators who need to view all user data.
 * @data_structure The data is structured hierarchically under `/users/{userId}`.
 * @key_security_decisions User listing is denied for regular users but allowed for admins. All other data is private to the user unless accessed by an admin.
 * @denormalization This ruleset uses path-based authorization and reads the `isAdmin` flag from the user's own profile document to grant special privileges.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to the collection of all users.
     * @path /users
     * @allow (list) Only authenticated users who are marked as admins can list all users. The `get()` call to the user's own profile is efficient and secure for this role-based access.
     * @deny (list) Regular users cannot list all users.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isAdmin() {
        return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
      }
      
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isOwner(userId);
    }

    /**
     * @description Controls access to workout documents within a user's profile.
     * @path /users/{userId}/workouts/{workoutId}
     * @allow (get, list) User with matching UID or an admin can read and list workout documents.
     * @allow (create, update, delete) Only the owner can write or delete their own workout documents.
     * @principle Enforces document ownership for write operations, but allows admin read access.
     */
    match /users/{userId}/workouts/{workoutId} {
       function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isAdmin() {
        return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
      }

      allow get: if isOwner(userId) || isAdmin();
      allow list: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) && request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Controls access to photo verification documents within a user's workout.
     * @path /users/{userId}/workouts/{workoutId}/photos/{photoId}
     * @allow (get, list) User with matching UID or an admin can read and list photo documents.
     * @allow (create, update, delete) Only the owner can write or delete their own photo documents.
     * @principle Enforces document ownership for write operations, but allows admin read access.
     */
    match /users/{userId}/workouts/{workoutId}/photos/{photoId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isAdmin() {
        return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
      }

      allow get: if isOwner(userId) || isAdmin();
      allow list: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }
  }
}
